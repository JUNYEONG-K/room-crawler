const chromium = require('chrome-aws-lambda');
const cheerio = require("serverless-offline/src/lambda/handler-runner/in-process-runner/aws-lambda-ric/UserFunction");

const place = {
    '홍대입구역': 'https://www.dabangapp.com/search/map?filters=%7B%22multi_room_type%22%3A%5B0%2C1%5D%2C%22selling_type%22%3A%5B0%5D%2C%22deposit_range%22%3A%5B0%2C999999%5D%2C%22price_range%22%3A%5B0%2C999999%5D%2C%22trade_range%22%3A%5B0%2C999999%5D%2C%22maintenance_cost_range%22%3A%5B0%2C999999%5D%2C%22room_size%22%3A%5B0%2C999999%5D%2C%22supply_space_range%22%3A%5B0%2C999999%5D%2C%22room_floor_multi%22%3A%5B1%2C2%2C3%2C4%2C5%2C6%2C7%2C-1%2C0%5D%2C%22division%22%3Afalse%2C%22duplex%22%3Afalse%2C%22room_type%22%3A%5B1%2C2%5D%2C%22use_approval_date_range%22%3A%5B0%2C999999%5D%2C%22parking_average_range%22%3A%5B0%2C999999%5D%2C%22household_num_range%22%3A%5B0%2C999999%5D%2C%22parking%22%3Afalse%2C%22short_lease%22%3Afalse%2C%22full_option%22%3Afalse%2C%22built_in%22%3Afalse%2C%22elevator%22%3Afalse%2C%22balcony%22%3Afalse%2C%22safety%22%3Afalse%2C%22pano%22%3Afalse%2C%22is_contract%22%3Afalse%2C%22deal_type%22%3A%5B0%2C1%5D%7D&position=%7B%22location%22%3A%5B%5B126.9085505%2C37.5442571%5D%2C%5B126.9428827%2C37.5722899%5D%5D%2C%22center%22%3A%5B126.92571658987902%2C37.558274845977955%5D%2C%22zoom%22%3A15%7D&search=%7B%22id%22%3A%22subway_704%22%2C%22type%22%3A%22subway%22%2C%22name%22%3A%22%ED%99%8D%EB%8C%80%EC%9E%85%EA%B5%AC%EC%97%AD%22%7D&tab=all',
    '상수역': 'https://www.dabangapp.com/search/map?filters=%7B%22multi_room_type%22%3A%5B0%2C1%5D%2C%22selling_type%22%3A%5B0%5D%2C%22deposit_range%22%3A%5B0%2C999999%5D%2C%22price_range%22%3A%5B0%2C999999%5D%2C%22trade_range%22%3A%5B0%2C999999%5D%2C%22maintenance_cost_range%22%3A%5B0%2C999999%5D%2C%22room_size%22%3A%5B0%2C999999%5D%2C%22supply_space_range%22%3A%5B0%2C999999%5D%2C%22room_floor_multi%22%3A%5B1%2C2%2C3%2C4%2C5%2C6%2C7%2C-1%2C0%5D%2C%22division%22%3Afalse%2C%22duplex%22%3Afalse%2C%22room_type%22%3A%5B1%2C2%5D%2C%22use_approval_date_range%22%3A%5B0%2C999999%5D%2C%22parking_average_range%22%3A%5B0%2C999999%5D%2C%22household_num_range%22%3A%5B0%2C999999%5D%2C%22parking%22%3Afalse%2C%22short_lease%22%3Afalse%2C%22full_option%22%3Afalse%2C%22built_in%22%3Afalse%2C%22elevator%22%3Afalse%2C%22balcony%22%3Afalse%2C%22safety%22%3Afalse%2C%22pano%22%3Afalse%2C%22is_contract%22%3Afalse%2C%22deal_type%22%3A%5B0%2C1%5D%7D&position=%7B%22location%22%3A%5B%5B126.9057823%2C37.5336788%5D%2C%5B126.9401146%2C37.5617156%5D%5D%2C%22center%22%3A%5B126.92294842615615%2C37.54769849388519%5D%2C%22zoom%22%3A15%7D&search=%7B%22id%22%3A%22%22%2C%22type%22%3A%22%22%2C%22name%22%3A%22%22%7D&tab=all',
    '합정역': 'https://www.dabangapp.com/search/map?filters=%7B%22multi_room_type%22%3A%5B0%2C1%5D%2C%22selling_type%22%3A%5B0%5D%2C%22deposit_range%22%3A%5B0%2C999999%5D%2C%22price_range%22%3A%5B0%2C999999%5D%2C%22trade_range%22%3A%5B0%2C999999%5D%2C%22maintenance_cost_range%22%3A%5B0%2C999999%5D%2C%22room_size%22%3A%5B0%2C999999%5D%2C%22supply_space_range%22%3A%5B0%2C999999%5D%2C%22room_floor_multi%22%3A%5B1%2C2%2C3%2C4%2C5%2C6%2C7%2C-1%2C0%5D%2C%22division%22%3Afalse%2C%22duplex%22%3Afalse%2C%22room_type%22%3A%5B1%2C2%5D%2C%22use_approval_date_range%22%3A%5B0%2C999999%5D%2C%22parking_average_range%22%3A%5B0%2C999999%5D%2C%22household_num_range%22%3A%5B0%2C999999%5D%2C%22parking%22%3Afalse%2C%22short_lease%22%3Afalse%2C%22full_option%22%3Afalse%2C%22built_in%22%3Afalse%2C%22elevator%22%3Afalse%2C%22balcony%22%3Afalse%2C%22safety%22%3Afalse%2C%22pano%22%3Afalse%2C%22is_contract%22%3Afalse%2C%22deal_type%22%3A%5B0%2C1%5D%7D&position=%7B%22location%22%3A%5B%5B126.8962679%2C37.5351203%5D%2C%5B126.9306002%2C37.5631566%5D%5D%2C%22center%22%3A%5B126.9134340733292%2C37.54913979490922%5D%2C%22zoom%22%3A15%7D&search=%7B%22id%22%3A%22subway_694%22%2C%22type%22%3A%22subway%22%2C%22name%22%3A%22%ED%95%A9%EC%A0%95%EC%97%AD%22%7D&tab=all',
    '망원역': 'https://www.dabangapp.com/search/map?filters=%7B%22multi_room_type%22%3A%5B0%2C1%5D%2C%22selling_type%22%3A%5B0%5D%2C%22deposit_range%22%3A%5B0%2C999999%5D%2C%22price_range%22%3A%5B0%2C999999%5D%2C%22trade_range%22%3A%5B0%2C999999%5D%2C%22maintenance_cost_range%22%3A%5B0%2C999999%5D%2C%22room_size%22%3A%5B0%2C999999%5D%2C%22supply_space_range%22%3A%5B0%2C999999%5D%2C%22room_floor_multi%22%3A%5B1%2C2%2C3%2C4%2C5%2C6%2C7%2C-1%2C0%5D%2C%22division%22%3Afalse%2C%22duplex%22%3Afalse%2C%22room_type%22%3A%5B1%2C2%5D%2C%22use_approval_date_range%22%3A%5B0%2C999999%5D%2C%22parking_average_range%22%3A%5B0%2C999999%5D%2C%22household_num_range%22%3A%5B0%2C999999%5D%2C%22parking%22%3Afalse%2C%22short_lease%22%3Afalse%2C%22full_option%22%3Afalse%2C%22built_in%22%3Afalse%2C%22elevator%22%3Afalse%2C%22balcony%22%3Afalse%2C%22safety%22%3Afalse%2C%22pano%22%3Afalse%2C%22is_contract%22%3Afalse%2C%22deal_type%22%3A%5B0%2C1%5D%7D&position=%7B%22location%22%3A%5B%5B126.8929212%2C37.5419852%5D%2C%5B126.9272535%2C37.5700189%5D%5D%2C%22center%22%3A%5B126.9100873619318%2C37.55600339347314%5D%2C%22zoom%22%3A15%7D&search=%7B%22id%22%3A%22subway_243%22%2C%22type%22%3A%22subway%22%2C%22name%22%3A%22%EB%A7%9D%EC%9B%90%EC%97%AD%22%7D&tab=all',
    '마포구청역': 'https://www.dabangapp.com/search/map?filters=%7B%22multi_room_type%22%3A%5B0%2C1%5D%2C%22selling_type%22%3A%5B0%5D%2C%22deposit_range%22%3A%5B0%2C999999%5D%2C%22price_range%22%3A%5B0%2C999999%5D%2C%22trade_range%22%3A%5B0%2C999999%5D%2C%22maintenance_cost_range%22%3A%5B0%2C999999%5D%2C%22room_size%22%3A%5B0%2C999999%5D%2C%22supply_space_range%22%3A%5B0%2C999999%5D%2C%22room_floor_multi%22%3A%5B1%2C2%2C3%2C4%2C5%2C6%2C7%2C-1%2C0%5D%2C%22division%22%3Afalse%2C%22duplex%22%3Afalse%2C%22room_type%22%3A%5B1%2C2%5D%2C%22use_approval_date_range%22%3A%5B0%2C999999%5D%2C%22parking_average_range%22%3A%5B0%2C999999%5D%2C%22household_num_range%22%3A%5B0%2C999999%5D%2C%22parking%22%3Afalse%2C%22short_lease%22%3Afalse%2C%22full_option%22%3Afalse%2C%22built_in%22%3Afalse%2C%22elevator%22%3Afalse%2C%22balcony%22%3Afalse%2C%22safety%22%3Afalse%2C%22pano%22%3Afalse%2C%22is_contract%22%3Afalse%2C%22deal_type%22%3A%5B0%2C1%5D%7D&position=%7B%22location%22%3A%5B%5B126.8861716%2C37.5495131%5D%2C%5B126.9205039%2C37.5775439%5D%5D%2C%22center%22%3A%5B126.9033377468586%2C37.56352981684971%5D%2C%22zoom%22%3A15%7D&search=%7B%22id%22%3A%22subway_237%22%2C%22type%22%3A%22subway%22%2C%22name%22%3A%22%EB%A7%88%ED%8F%AC%EA%B5%AC%EC%B2%AD%EC%97%AD%22%7D&tab=all',
    '광흥창역': 'https://www.dabangapp.com/search/map?filters=%7B%22multi_room_type%22%3A%5B0%2C1%5D%2C%22selling_type%22%3A%5B0%5D%2C%22deposit_range%22%3A%5B0%2C999999%5D%2C%22price_range%22%3A%5B0%2C999999%5D%2C%22trade_range%22%3A%5B0%2C999999%5D%2C%22maintenance_cost_range%22%3A%5B0%2C999999%5D%2C%22room_size%22%3A%5B0%2C999999%5D%2C%22supply_space_range%22%3A%5B0%2C999999%5D%2C%22room_floor_multi%22%3A%5B1%2C2%2C3%2C4%2C5%2C6%2C7%2C-1%2C0%5D%2C%22division%22%3Afalse%2C%22duplex%22%3Afalse%2C%22room_type%22%3A%5B1%2C2%5D%2C%22use_approval_date_range%22%3A%5B0%2C999999%5D%2C%22parking_average_range%22%3A%5B0%2C999999%5D%2C%22household_num_range%22%3A%5B0%2C999999%5D%2C%22parking%22%3Afalse%2C%22short_lease%22%3Afalse%2C%22full_option%22%3Afalse%2C%22built_in%22%3Afalse%2C%22elevator%22%3Afalse%2C%22balcony%22%3Afalse%2C%22safety%22%3Afalse%2C%22pano%22%3Afalse%2C%22is_contract%22%3Afalse%2C%22deal_type%22%3A%5B0%2C1%5D%7D&position=%7B%22location%22%3A%5B%5B126.9148367%2C37.5334347%5D%2C%5B126.949169%2C37.5614716%5D%5D%2C%22center%22%3A%5B126.932002827525%2C37.5474544561707%5D%2C%22zoom%22%3A15%7D&search=%7B%22id%22%3A%22subway_68%22%2C%22type%22%3A%22subway%22%2C%22name%22%3A%22%EA%B4%91%ED%9D%A5%EC%B0%BD%EC%97%AD%22%7D&tab=all',
    '신촌역': 'https://www.dabangapp.com/search/map?filters=%7B%22multi_room_type%22%3A%5B0%2C1%5D%2C%22selling_type%22%3A%5B0%5D%2C%22deposit_range%22%3A%5B0%2C999999%5D%2C%22price_range%22%3A%5B0%2C999999%5D%2C%22trade_range%22%3A%5B0%2C999999%5D%2C%22maintenance_cost_range%22%3A%5B0%2C999999%5D%2C%22room_size%22%3A%5B0%2C999999%5D%2C%22supply_space_range%22%3A%5B0%2C999999%5D%2C%22room_floor_multi%22%3A%5B1%2C2%2C3%2C4%2C5%2C6%2C7%2C-1%2C0%5D%2C%22division%22%3Afalse%2C%22duplex%22%3Afalse%2C%22room_type%22%3A%5B1%2C2%5D%2C%22use_approval_date_range%22%3A%5B0%2C999999%5D%2C%22parking_average_range%22%3A%5B0%2C999999%5D%2C%22household_num_range%22%3A%5B0%2C999999%5D%2C%22parking%22%3Afalse%2C%22short_lease%22%3Afalse%2C%22full_option%22%3Afalse%2C%22built_in%22%3Afalse%2C%22elevator%22%3Afalse%2C%22balcony%22%3Afalse%2C%22safety%22%3Afalse%2C%22pano%22%3Afalse%2C%22is_contract%22%3Afalse%2C%22deal_type%22%3A%5B0%2C1%5D%7D&position=%7B%22location%22%3A%5B%5B126.9197237%2C37.541124%5D%2C%5B126.954056%2C37.569158%5D%5D%2C%22center%22%3A%5B126.93688987534824%2C37.555142331403246%5D%2C%22zoom%22%3A15%7D&search=%7B%22id%22%3A%22subway_458%22%2C%22type%22%3A%22subway%22%2C%22name%22%3A%22%EC%8B%A0%EC%B4%8C%EC%97%AD%22%7D&tab=all',
    '대흥역': 'https://www.dabangapp.com/search/map?filters=%7B%22multi_room_type%22%3A%5B0%2C1%5D%2C%22selling_type%22%3A%5B0%5D%2C%22deposit_range%22%3A%5B0%2C999999%5D%2C%22price_range%22%3A%5B0%2C999999%5D%2C%22trade_range%22%3A%5B0%2C999999%5D%2C%22maintenance_cost_range%22%3A%5B0%2C999999%5D%2C%22room_size%22%3A%5B0%2C999999%5D%2C%22supply_space_range%22%3A%5B0%2C999999%5D%2C%22room_floor_multi%22%3A%5B1%2C2%2C3%2C4%2C5%2C6%2C7%2C-1%2C0%5D%2C%22division%22%3Afalse%2C%22duplex%22%3Afalse%2C%22room_type%22%3A%5B1%2C2%5D%2C%22use_approval_date_range%22%3A%5B0%2C999999%5D%2C%22parking_average_range%22%3A%5B0%2C999999%5D%2C%22household_num_range%22%3A%5B0%2C999999%5D%2C%22parking%22%3Afalse%2C%22short_lease%22%3Afalse%2C%22full_option%22%3Afalse%2C%22built_in%22%3Afalse%2C%22elevator%22%3Afalse%2C%22balcony%22%3Afalse%2C%22safety%22%3Afalse%2C%22pano%22%3Afalse%2C%22is_contract%22%3Afalse%2C%22deal_type%22%3A%5B0%2C1%5D%7D&position=%7B%22location%22%3A%5B%5B126.9250297%2C37.5337078%5D%2C%5B126.959362%2C37.5617447%5D%5D%2C%22center%22%3A%5B126.94219587743282%2C37.54772756659767%5D%2C%22zoom%22%3A15%7D&search=%7B%22id%22%3A%22subway_181%22%2C%22type%22%3A%22subway%22%2C%22name%22%3A%22%EB%8C%80%ED%9D%A5%EC%97%AD%22%7D&tab=all',
}

module.exports.hello = async event => {
    const which = event.queryStringParameters.place;
    const rooms = [];
    const browser = await chromium.puppeteer.launch({
        args: chromium.args,
        defaultViewport: chromium.defaultViewport,
        executablePath: await chromium.executablePath,
        headless: chromium.headless,
        ignoreHTTPSErrors: true,

    });
    const page = await browser.newPage();
    await page.goto(place[which]);
    const content = await page.content();
    const $ = cheerio.load(content);
    const lists = (await $)('#content > div.styled__Content-sc-1nnkzie-0.la-dQXm > div.styled__ListWrap-sc-5dgg47-0.HgyKn > div > div > div.simplebar-wrapper > div.simplebar-mask > div > div > div > ul.styled__ItemList-sc-5dgg47-2.styled__NormalList-vhzehm-2.feJoKT.gpAuUS > li')
    await lists.each(async (index, list) => {
        const price = (await $)(list).find('div > div > div > h1').text();
        const type = (await $)(list).find('div > div > div > p.styled__RoomType-sc-1fwit0q-9.etdxaS').text();
        const info = (await $)(list).find('div > div > div> p:nth-child(3)').text();
        const spec = (await $)(list).find('div > div > div > p:nth-child(4)').text();
        rooms.push({index, price, type, info, spec});
    })
    console.log(rooms)
    await browser.close();
    return {
        statusCode: 200,
        body: JSON.stringify({
            rooms: rooms,
        })
    }
}